#!/usr/bin/env bash

# Echo commands to stdout.
set -x

# Exit on first error.
set -e

# Treat undefined environment variables as errors.
set -u

BOOT_CONFIG_PATH=/boot/firmware/config.txt
OTG_OVERLAY="dtoverlay=dwc2,dr_mode=peripheral"

# Raspberry Pi OS moved the boot config to /boot/firmware starting with Bookworm,
# but older releases still use /boot/config.txt. Detect the correct path so the
# overlay is appended to the right file.
if [ ! -f "$BOOT_CONFIG_PATH" ]; then
  BOOT_CONFIG_PATH=/boot/config.txt
fi

if [ ! -f "$BOOT_CONFIG_PATH" ]; then
  echo "Could not find Raspberry Pi boot config file" >&2
  exit 1
fi

if grep -q '^dtoverlay=dwc2' "$BOOT_CONFIG_PATH"; then
  # Force peripheral mode so the USB controller presents as a gadget (creates /dev/hidg0).
  sed -i "s/^dtoverlay=dwc2.*/${OTG_OVERLAY}/" "$BOOT_CONFIG_PATH"
else
  echo "$OTG_OVERLAY" >> "$BOOT_CONFIG_PATH"
fi

if ! grep -q '^dwc2' /etc/modules; then
  echo "dwc2" >> /etc/modules
fi

ENABLE_RPI_HID_PATH=/opt/enable-rpi-hid
ENABLE_RPI_HID_DIR=$(dirname $ENABLE_RPI_HID_PATH)

mkdir -p "$ENABLE_RPI_HID_DIR"
wget https://raw.githubusercontent.com/mtlynch/ansible-role-key-mime-pi/master/files/enable-rpi-hid \
  -O "$ENABLE_RPI_HID_PATH"
chmod +x "$ENABLE_RPI_HID_PATH"

cd $(mktemp -d)
wget https://raw.githubusercontent.com/mtlynch/ansible-role-key-mime-pi/master/templates/usb-gadget.systemd.j2
USB_GADGET_SERVICE_PATH=/etc/systemd/system/usb-gadget.service
sed -e "s@{{ key_mime_pi_initialize_hid_script_path }}@${ENABLE_RPI_HID_PATH}@g" \
  usb-gadget.systemd.j2 > "$USB_GADGET_SERVICE_PATH"

systemctl daemon-reload
systemctl enable usb-gadget.service
